<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>GSOC 2023 - Python Agent Performance Enhancement Plan 项目提案 | Alrisha</title><meta name="author" content="FAWC,kevin_lgh@foxmail.com"><meta name="copyright" content="FAWC"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Apache SkyWalking - Python Agent Performance Enhancement PlanProposal for Google Summer of Code 2023  About MePersonal Information Name: *** Email: *** Github: @FAWC438 Blog: alrisha.cn ( in Chinese">
<meta property="og:type" content="article">
<meta property="og:title" content="GSOC 2023 - Python Agent Performance Enhancement Plan 项目提案">
<meta property="og:url" content="https://alrisha.cn/2023/09/3959450b.html">
<meta property="og:site_name" content="Alrisha">
<meta property="og:description" content="Apache SkyWalking - Python Agent Performance Enhancement PlanProposal for Google Summer of Code 2023  About MePersonal Information Name: *** Email: *** Github: @FAWC438 Blog: alrisha.cn ( in Chinese">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2023/09/05/SOnU7VK4tuedDAI.png">
<meta property="article:published_time" content="2023-09-05T01:53:41.000Z">
<meta property="article:modified_time" content="2024-02-24T12:54:27.280Z">
<meta property="article:author" content="FAWC">
<meta property="article:tag" content="Open Source">
<meta property="article:tag" content="Google Summer of Code">
<meta property="article:tag" content="Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2023/09/05/SOnU7VK4tuedDAI.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/gaming.svg"><link rel="canonical" href="https://alrisha.cn/2023/09/3959450b.html"><link rel="preconnect" href="//cdnjs.cloudflare.com"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//www.clarity.ms"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="0XuTTRNwC5ys6TFutW1GLvmtffD7QVYk-6BAsY5RaOg"/><meta name="baidu-site-verification" content="code-Ktb2MMTpFe"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?32241c273a93c8c23595f464d477ca45";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-RKQBB7LDQC"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-RKQBB7LDQC');
</script><script>(function(c,l,a,r,i,t,y){
    c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
    t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
    y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
})(window, document, "clarity", "script", "dy67k2hgwc");</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdnjs.cloudflare.com/ajax/libs/egjs-infinitegrid/4.11.1/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'GSOC 2023 - Python Agent Performance Enhancement Plan 项目提案',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-02-24 20:54:27'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...（若加载时间过长请尝试刷新页面或更换访问节点🙏）</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2024/02/29/ZkKG1RDmgLTqaoE.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2023/09/05/SOnU7VK4tuedDAI.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Alrisha"><span class="site-name">Alrisha</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">GSOC 2023 - Python Agent Performance Enhancement Plan 项目提案</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-05T01:53:41.000Z" title="发表于 2023-09-05 09:53:41">2023-09-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-02-24T12:54:27.280Z" title="更新于 2024-02-24 20:54:27">2024-02-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="GSOC 2023 - Python Agent Performance Enhancement Plan 项目提案"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><center>

<h1 id="Apache-SkyWalking-Python-Agent-Performance-Enhancement-Plan"><a href="#Apache-SkyWalking-Python-Agent-Performance-Enhancement-Plan" class="headerlink" title="Apache SkyWalking - Python Agent Performance Enhancement Plan"></a>Apache SkyWalking - Python Agent Performance Enhancement Plan</h1><h2 id="Proposal-for-Google-Summer-of-Code-2023"><a href="#Proposal-for-Google-Summer-of-Code-2023" class="headerlink" title="Proposal for Google Summer of Code 2023"></a>Proposal for Google Summer of Code 2023</h2></center>

<h2 id="About-Me"><a href="#About-Me" class="headerlink" title="About Me"></a>About Me</h2><h3 id="Personal-Information"><a href="#Personal-Information" class="headerlink" title="Personal Information"></a>Personal Information</h3><ul>
<li><strong>Name</strong>: ***</li>
<li><strong>Email</strong>: ***</li>
<li><strong>Github</strong>: <a target="_blank" rel="noopener" href="https://github.com/FAWC438">@FAWC438</a></li>
<li><strong>Blog</strong>: <a href="https://alrisha.cn/">alrisha.cn</a> ( in Chinese )</li>
<li><strong>Location</strong>: China</li>
<li><strong>Timezone</strong>: GMT+8</li>
<li><strong>University</strong>: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Beijing_University_of_Posts_and_Telecommunications">Beijing University of Posts and Telecommunications</a></li>
<li><strong>Degree in progress</strong>: Master of Computer Science and Technology</li>
</ul>
<h3 id="Why-Me"><a href="#Why-Me" class="headerlink" title="Why Me"></a>Why Me</h3><p>My primary programming languages are Python, Java and Go, with Python being my best. I am interested in microservices and cloud-native, especially for cloud-native observability.</p>
<p>Even though I’m new to open source, I’m passionate about code. I often write small programs using different technology stacks and upload them to my Github repository. This year is the first time I learned about Google Summer of Code, and I think participating in this event will definitely allow me to get more technically advanced and create cooler code!</p>
<p>I had experience with <a target="_blank" rel="noopener" href="https://github.com/open-telemetry/opentelemetry-python">OpenTelemetry</a> during one of my previous corporate internships, and since OpenTelemetry’s Python agent implementation is very similar to Skywalking’s Python agent, I believe I was able to quickly become familiar with Skywalking’s Python agent code architecture and operating principles.</p>
<p>I’m also familiar with the async concept. I am currently pursuing a Master’s degree in Computer Science and Technology at the <a target="_blank" rel="noopener" href="https://scs.bupt.edu.cn/info/1247/2656.htm">Information Networking Center</a> at Beijing University of Posts and Telecommunications. In my daily projects, I often need to implement large-scale network IO tasks, which gives me some experience with parallel programming.</p>
<h2 id="Project-Description"><a href="#Project-Description" class="headerlink" title="Project Description"></a>Project Description</h2><ul>
<li><strong>Project Name</strong>: <a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/COMDEV-502">Apache SkyWalking - Python Agent Performance Enhancement Plan</a></li>
<li><strong>Mentor</strong>: <a target="_blank" rel="noopener" href="https://github.com/Superskyyy">@Superskyyy</a>, <a target="_blank" rel="noopener" href="https://github.com/kezhenxu94">@kezhenxu94</a></li>
<li><strong>Abstract</strong>: Currently, SkyWalking Python agent is implemented with the Threading module to provide data reporters. Yet with the growth of the Python agent, it is now fully capable and requires more resources than when only tracing was supported.</li>
<li><strong>Goal</strong>:<ul>
<li>Deprecate or provide an alternative implementation of data reporters (Trace&#x2F;Log&#x2F;Meter), maybe also for profilers.</li>
<li>The alternative implementation should also work for gRPC&#x2F;HTTP&#x2F;Kafka using corresponding async clients.</li>
<li>A simple but reliable performance test job in CI&#x2F;local.</li>
</ul>
</li>
</ul>
<h2 id="Homework"><a href="#Homework" class="headerlink" title="Homework"></a>Homework</h2><h3 id="Familiarity-with-the-Skywalking-Ecosystem"><a href="#Familiarity-with-the-Skywalking-Ecosystem" class="headerlink" title="Familiarity with the Skywalking Ecosystem"></a>Familiarity with the Skywalking Ecosystem</h3><ul>
<li>Build from source and run Skywalking Python agent, make dev environment and dependencies ready on my machine.</li>
<li>Try to finish the task in <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking/issues/10447">issue#10447</a>, currently waiting for mentor to reproduce the problem with my code.</li>
</ul>
<h3 id="Investigate-Asynchronous-Protocol-API-Implementations"><a href="#Investigate-Asynchronous-Protocol-API-Implementations" class="headerlink" title="Investigate Asynchronous Protocol API Implementations"></a>Investigate Asynchronous Protocol API Implementations</h3><h4 id="For-gRPC"><a href="#For-gRPC" class="headerlink" title="For gRPC"></a>For gRPC</h4><p>The more clear solution is to use the official <a target="_blank" rel="noopener" href="https://grpc.github.io/grpc/python/grpc_asyncio.html">grpc.aio</a>, which obviously has the best support.</p>
<h4 id="For-Kafka"><a href="#For-Kafka" class="headerlink" title="For Kafka"></a>For Kafka</h4><p><a target="_blank" rel="noopener" href="https://github.com/confluentinc/confluent-kafka-python">confluent kafka</a> and <a target="_blank" rel="noopener" href="https://github.com/aio-libs/aiokafka">aiokafka</a> can both be used for asynchronous api.</p>
<ul>
<li>confluent kafka has a more active community, but currently does not support out-of-the-box use of asynio and requires <a target="_blank" rel="noopener" href="https://www.confluent.io/blog/kafka-python-asyncio-integration/">more code</a> to implement asynchronous functionality.</li>
<li>aiokafka’s API is more convenient and intuitive to use, and it seamlessly supports the asyncio library. But it has a relatively small community and may not have an advantage in terms of performance.</li>
</ul>
<p>Here is a simple benchmark of the two libraries (Skywalking Python agent always plays a role of kafka <strong>producer</strong>):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> confluent_kafka <span class="keyword">import</span> KafkaException</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> aiokafka <span class="keyword">import</span> AIOKafkaProducer</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> confluent_kafka</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AIOProducer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, configs, loop=<span class="literal">None</span></span>):</span><br><span class="line">        self._loop = loop <span class="keyword">or</span> asyncio.get_event_loop()</span><br><span class="line">        self._producer = confluent_kafka.Producer(configs)</span><br><span class="line">        self._cancelled = <span class="literal">False</span></span><br><span class="line">        self._poll_thread = Thread(target=self._poll_loop)</span><br><span class="line">        self._poll_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_poll_loop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self._cancelled:</span><br><span class="line">            self._producer.poll(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">        self._cancelled = <span class="literal">True</span></span><br><span class="line">        self._poll_thread.join()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">produce_with_callback</span>(<span class="params">self, topic, value, on_delivery=<span class="literal">None</span></span>):</span><br><span class="line">        result = self._loop.create_future()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">ack</span>(<span class="params">err, msg</span>):</span><br><span class="line">            <span class="keyword">if</span> err:</span><br><span class="line">                self._loop.call_soon_threadsafe(result.set_exception, KafkaException(err))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._loop.call_soon_threadsafe(result.set_result, msg)</span><br><span class="line">            <span class="keyword">if</span> on_delivery:</span><br><span class="line">                self._loop.call_soon_threadsafe(on_delivery, err, msg)</span><br><span class="line">        self._producer.produce(topic, value, on_delivery=ack)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DATA_SIZE = <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_confluent</span>():</span><br><span class="line">    producer = AIOProducer(&#123;<span class="string">&quot;bootstrap.servers&quot;</span>: <span class="string">&quot;localhost:9094&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(DATA_SIZE):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Produce messages</span></span><br><span class="line">            <span class="keyword">await</span> producer.produce_with_callback(<span class="string">&quot;test-topic&quot;</span>, <span class="string">&quot;message&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    producer.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_aio</span>():</span><br><span class="line">    producer = AIOKafkaProducer(bootstrap_servers=<span class="string">&#x27;localhost:9094&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> producer.start()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(DATA_SIZE):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Produce messages</span></span><br><span class="line">           <span class="keyword">await</span> producer.send_and_wait(<span class="string">&quot;test-topic&quot;</span>, <span class="string">b&quot;message&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">await</span> producer.stop()</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">await</span> producer.stop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_normal</span>(<span class="params">on_delivery=<span class="literal">None</span></span>):</span><br><span class="line">    producer = confluent_kafka.Producer(&#123;<span class="string">&quot;bootstrap.servers&quot;</span>: <span class="string">&quot;localhost:9094&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(DATA_SIZE):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Produce messages</span></span><br><span class="line">            producer.poll(<span class="number">0</span>)</span><br><span class="line">            producer.produce(<span class="string">&quot;test-topic&quot;</span>, <span class="string">&quot;message&quot;</span>, on_delivery=on_delivery)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    producer.flush()</span><br><span class="line"></span><br><span class="line">start_time = time.perf_counter()</span><br><span class="line">asyncio.run(send_confluent())</span><br><span class="line">end_time = time.perf_counter()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;confluent_kafka async: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds&quot;</span>)</span><br><span class="line"></span><br><span class="line">start_time = time.perf_counter()</span><br><span class="line">asyncio.run(send_aio())</span><br><span class="line">end_time = time.perf_counter()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;aiokafka async: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ack</span>(<span class="params">err, msg</span>):</span><br><span class="line">    <span class="keyword">global</span> cnt</span><br><span class="line">    cnt = cnt + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">start_time = time.perf_counter()</span><br><span class="line">send_normal(ack)</span><br><span class="line">end_time = time.perf_counter()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;confluent_kafka sync: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>The result is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">confluent_kafka async: 27.60 seconds</span><br><span class="line">aiokafka async: 3.66 seconds</span><br><span class="line">confluent_kafka <span class="built_in">sync</span>: 0.03 seconds</span><br></pre></td></tr></table></figure>

<p>Let me explain this result in detail.</p>
<p>In confluent kafka, the main blocking operations are the <a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/clients/confluent-kafka-python/html/index.html#confluent_kafka.Producer.poll">poll()</a>&#x2F;<a target="_blank" rel="noopener" href="https://docs.confluent.io/platform/current/clients/confluent-kafka-python/html/index.html#confluent_kafka.Producer.flush">flush()</a> functions, which are used to receive callback events for messages produced by the producer (see this <a target="_blank" rel="noopener" href="https://github.com/confluentinc/confluent-kafka-python/issues/137#issuecomment-282427382">issue</a>). To enable confluent kafka to run on the asyncio model, the official example (and the code I wrote) implements the asyncio interface by binding the <code>poll()</code> operation to an additional thread and making the <code>produce()</code> operation mandatory for the callback function <code>ack()</code>. This results in <strong>having to execute a callback function involving a cross-thread call after each production data</strong>, which I think is the main reason why confluent kafka performs very poorly in the asyncio model.</p>
<p>In addition, aiokafka performs normally under asynchronous tasks, but I also found that confluent kafka performs exceptionally well under the traditional synchronous model (aiokafka does not have an interface for synchronous tasks).</p>
<p>On the one hand, this is because my callback function is relatively simple, on the other hand, I set the timeout parameter of the <code>poll()</code> function to 0, which means that the producer will not have any waits for the callback of the sent information. In my case it worked fine, but in more heavy workloads, this is likely to cause confluent kafka’s local buffer queue to overflow and cause catastrophic consequences such as data loss. I actually ran into this problem while working on <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking/issues/10447">issue#10447</a>. If we try to slightly increase the <code>poll()</code> timeout parameter in the synchronous task, for example, set it to <code>0.1</code> (seconds), we can see what the result is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">confluent_kafka <span class="built_in">sync</span>: 27.92 seconds</span><br></pre></td></tr></table></figure>

<p>As expected, its performance plummeted.</p>
<p>So in summary, aiokafka seems to be <strong>better</strong> than confluent kafka in all aspects in terms of support for the asyncio model</p>
<h4 id="For-HTTP"><a href="#For-HTTP" class="headerlink" title="For HTTP"></a>For HTTP</h4><p><a target="_blank" rel="noopener" href="https://github.com/encode/httpx">httpx</a> and <a target="_blank" rel="noopener" href="https://github.com/aio-libs/aiohttp">aiohttp</a> can both be used for asynchronous api.</p>
<p>There is a <a target="_blank" rel="noopener" href="https://oxylabs.io/blog/httpx-vs-requests-vs-aiohttp">related blog</a> for reference.</p>
<ul>
<li>httpx is a very comprehensive python networking library that greatly extends python’s traditional requests and other libraries to support many new features, including, of course, asyncio asynchronous support, which we need in particular. Its API is almost similar to that of the traditional requests library, so it’s less difficult to get started and has a more active community. However, its powerful and comprehensive features maybe also its downside, as its performance for asynchronous tasks does not seem to be as good as the aiohttp library, which focuses on asynchronous optimization.</li>
<li>The aiohttp library is another available option. It is focused on optimizing python’s asynchronous network io performance and does not have many additional feature extensions. Given that the goal of this project is performance optimization rather than feature extensions, aiohttp is probably the better choice.</li>
</ul>
<p>Here is a simple benchmark of the two libraries (Windows WSL platform, 12-core Intel CPU):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line">REQUEST_NUMBER = <span class="number">1000</span></span><br><span class="line">TARGET_HTTP_URL = <span class="string">&quot;http://10.3.242.223:9999/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">httpx_test</span>():</span><br><span class="line">    httpx_client = httpx.AsyncClient()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Send 100 asynchronous GET requests using HTTPX</span></span><br><span class="line">        start_time = time.perf_counter()</span><br><span class="line">        tasks = [httpx_client.get(TARGET_HTTP_URL) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(REQUEST_NUMBER)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">        end_time = time.perf_counter()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;HTTPX: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">await</span> httpx_client.aclose()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">aiohttp_test</span>():</span><br><span class="line">    aiohttp_client = aiohttp.ClientSession()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Send 100 asynchronous GET requests using AIOHTTP</span></span><br><span class="line">        start_time = time.perf_counter()</span><br><span class="line">        tasks = [aiohttp_client.get(TARGET_HTTP_URL) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(REQUEST_NUMBER)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">        end_time = time.perf_counter()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;AIOHTTP: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">await</span> aiohttp_client.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># asyncio.run(main())</span></span><br><span class="line">asyncio.run(httpx_test())</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">asyncio.run(aiohttp_test())</span><br></pre></td></tr></table></figure>

<p>I deployed the flask service on port 9999 on a server on the campus LAN and made asynchronous requests to port 9999 locally via httpx and aiohttp respectively. The results are as follows:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HTTPX: 2.75 seconds</span><br><span class="line">AIOHTTP: 1.47 seconds</span><br></pre></td></tr></table></figure>

<p>So far it looks like aiohttp has a real performance advantage, as mentioned in that <a target="_blank" rel="noopener" href="https://oxylabs.io/blog/httpx-vs-requests-vs-aiohttp">blog</a>. However, after I set the <code>TARGET_HTTP_URL</code> parameter to a domain name on the Internet, the result is the exact <strong>opposite</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 100 requests https://www.baidu.com</span></span><br><span class="line">HTTPX: 0.41 seconds</span><br><span class="line">AIOHTTP: 1.07 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100 requests https://www.microsoft.com</span></span><br><span class="line">HTTPX: 3.76 seconds</span><br><span class="line">AIOHTTP: 4.42 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100 requests https://www.bupt.edu.cn</span></span><br><span class="line">HTTPX: 0.38 seconds</span><br><span class="line">AIOHTTP: 1.10 seconds</span><br></pre></td></tr></table></figure>

<p>Also, httpx is more stable. When I use a proxy or access some URLs that are very slow to respond, httpx always returns correctly, while aiohttp is sometimes slower or wrong.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 100 requests https://google.github.io/gsocguides/ Frist try</span></span><br><span class="line">HTTPX: 1.25 seconds</span><br><span class="line">AIOHTTP: 0.95 seconds</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100 requests https://google.github.io/gsocguides/ Second try</span></span><br><span class="line">HTTPX: 1.18 seconds</span><br><span class="line">AIOHTTP: 1.77 seconds</span><br></pre></td></tr></table></figure>

<p>I guess this is probably because httpx is optimized for production deployments, e.g. in terms of DNS or retransmission policies, while aiohttp does not do a good job in this area and lacks stability.</p>
<p>In addition, aiohttp <a target="_blank" rel="noopener" href="https://docs.aiohttp.org/en/latest/http_request_lifecycle.html">needs more codes</a> in implementation, at this point httpx is more convenient.</p>
<p>In summary, aiohttp has a performance advantage over httpx, but this is in theory. In a broader network environment, httpx is more stable, has better availability, and has smoother performance (aiohttp’s performance fluctuates more). And httpx requires less code than aiohttp, which can also increase code readability and development efficiency. Finally, httpx additionally supports many new features not supported by aiohttp, such as http&#x2F;2.0, which may also benefit the Skywalking Python agent for future expansion.</p>
<p>However, given that the main goal of this proposal is just IO performance improvement, the choice between these two options needs to be explored in more depth.</p>
<h2 id="Investigate-queues-used-between-both-synchronous-and-asynchronous-code"><a href="#Investigate-queues-used-between-both-synchronous-and-asynchronous-code" class="headerlink" title="Investigate queues used between both synchronous and asynchronous code"></a>Investigate queues used between both synchronous and asynchronous code</h2><p>Due to the highly invasive nature of making asyncio changes, code refactoring will be a recursive process, which may result in python agent users being overly aware of async code. For this, we may need a bridge to properly buffer the difference between synchronous code and asynchronous code, instead of turning all the code into asynchronous implementation. It’s a good idea to retrofit on the queue.</p>
<p>A more suitable option is to use the <a target="_blank" rel="noopener" href="https://github.com/aio-libs/janus">janus</a> queue. It is simple enough, light enough, and can meet the current requirements. <a target="_blank" rel="noopener" href="https://github.com/dano/aioprocessing">aioprocessing</a>‘s queue is also an alternative, but it is more complex and has many features we don’t use</p>
<p>It must be made clear that janus still has limit with usability. For example, in a thread where there is no asyncio event loop, we can’t create janus queues directly (see this <a target="_blank" rel="noopener" href="https://github.com/aio-libs/janus/issues/448">issue</a>).</p>
<p>In addition, using a cross-synchronous-asynchronous queue will definitely cause performance loss. janus’s <a target="_blank" rel="noopener" href="https://github.com/aio-libs/janus/issues/419">issue#419</a> mentions this problem. The reason is probably that the underlying implementation is basically based on calling <code>asyncio.run_in_executor()</code> , which leads to the overhead of internal threads.</p>
<p>Therefore, it is also necessary to use asyncio queue when implementing asyncio refactoring. Once it is confirmed that no thread safety issues will be raised, asyncio queue is clearly our first choice.</p>
<h2 id="Plan"><a href="#Plan" class="headerlink" title="Plan"></a>Plan</h2><ol>
<li><p><strong>Provide asyncio implementation of data reporters and protocol clients</strong></p>
<ul>
<li>Replace the Threading module of Trace&#x2F;Log&#x2F;Meter with asyncio.</li>
<li>Replace the protocol(gRPC&#x2F;Kafka&#x2F;HTTP) client implementation so that it supports the new concurrent model.</li>
<li>If the above tasks go well, the next refactoring may also be done for profilers. (Optional)</li>
<li>Considering that asyncio <a target="_blank" rel="noopener" href="https://github.com/python/cpython/issues/66197">cannot support fork</a>, additional multi-processing work may be required to make the Python agent run on an independent process. (Optional)</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>Extra info:</strong> According to <a target="_blank" rel="noopener" href="https://github.com/python/cpython/issues/66285#issuecomment-1322336873">this issue</a>, asyncio will fully support <code>fork()</code> in Python 3.12</p>
</blockquote>
<ol start="2">
<li><p><strong>Provide a simple but reliable performance test</strong></p>
<ul>
<li>The performance test should be able to test the performance of the new implementation and compare the performance of the new implementation with the performance of the old implementation.</li>
<li>If I find that some asyncio implementations are even difficult to surpass the previous thread implementation, I will focus on optimizing my code and consult my mentor; if the performance is still not satisfactory, I may still need to keep the old implementation.</li>
</ul>
</li>
<li><p><strong>Keep in Touch</strong></p>
<p>I will keep in touch with my mentor and the community through the mailing list and some instant messaging tools such as WeChat. If I run into a problem that I really have trouble solving on my own or have questions about Skywalking Python’s architecture and concepts, I’m very proactive in asking mentor questions.</p>
</li>
<li><p><strong>Output</strong></p>
<ul>
<li>Submit a PR to Apache Skywalking’s code repository.</li>
<li>Improve the relevant documentation.</li>
<li>Provide relevant quantitative data for performance optimization, such as the results of benchmark tests.</li>
</ul>
</li>
</ol>
<h2 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h2><blockquote>
<p>Depending on the progress of the project and the requirements of the mentor, this part may undergo some changes after coding officially begins.</p>
</blockquote>
<ul>
<li><strong>now to May 4: before Accepted GSoC contributor projects announced</strong><ul>
<li>Learn more about the Skywalking ecosystem</li>
<li>Try to submit the code related to <a target="_blank" rel="noopener" href="https://github.com/apache/skywalking/issues/10447">issue#10447</a> to PR</li>
<li>Learn which modules to focus on for improvement or refactoring in the Skywalking python agent. Run and test some of the threaded models in the code in my local environment by converting them to asyncio models</li>
<li>Before introducing the asyncio model, try replacing the protocol client implementation</li>
</ul>
</li>
<li><strong>May 4 to May 29: before Coding officially begins</strong><ul>
<li>Rough replacement of data reports from the threaded model to the asyncio model(Rough version, may lack usability)</li>
<li>Complete the basic replacement of the protocol client</li>
</ul>
</li>
<li><strong>May 29 to July 14: before Midterm evaluation</strong><ul>
<li>Iteratively optimize my code to further improve its usability&#x2F;performance</li>
<li>Complete some of the usability and performance testing, further discussion with Mentor may be required on what metrics are needed for testing</li>
<li>If the above tasks go well, a further asynchronous modification of the profilers module and multi-process refactoring is also possible</li>
</ul>
</li>
<li><strong>July 14 to August 21: before Final week</strong><ul>
<li>Complete the final replacement of the protocol client</li>
<li>Complete the final replacement of the data reporter</li>
<li>Complete the final performance testing</li>
<li>Code style and quality review, write documentation under the guidance of mentor</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://alrisha.cn">FAWC</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://alrisha.cn/2023/09/3959450b.html">https://alrisha.cn/2023/09/3959450b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://alrisha.cn" target="_blank">Alrisha</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Open-Source/">Open Source</a><a class="post-meta__tags" href="/tags/Google-Summer-of-Code/">Google Summer of Code</a><a class="post-meta__tags" href="/tags/Python/">Python</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2023/09/05/SOnU7VK4tuedDAI.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/8053138b.html" title="GSOC 2023 - 我的第一次开源之旅"><img class="cover" src="https://s2.loli.net/2023/09/05/SOnU7VK4tuedDAI.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">GSOC 2023 - 我的第一次开源之旅</div></div></a></div><div class="next-post pull-right"><a href="/2023/05/412bacf1.html" title="Nacos 单实例集群 Docker Compose 部署问题"><img class="cover" src="https://s2.loli.net/2023/05/08/ytsYGgT21pbqdCa.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nacos 单实例集群 Docker Compose 部署问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/09/8053138b.html" title="GSOC 2023 - 我的第一次开源之旅"><img class="cover" src="https://s2.loli.net/2023/09/05/SOnU7VK4tuedDAI.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-02-24</div><div class="title">GSOC 2023 - 我的第一次开源之旅</div></div></a></div><div><a href="/2023/02/2bf1425.html" title="Pandas 中判断某个元素是否存在的问题"><img class="cover" src="https://s2.loli.net/2024/03/21/jUW2m6iN94sTDKw.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-21</div><div class="title">Pandas 中判断某个元素是否存在的问题</div></div></a></div><div><a href="/2022/10/633fe4e4.html" title="Python 函数装饰器 @functools.lru_cache"><img class="cover" src="https://s2.loli.net/2024/03/21/jUW2m6iN94sTDKw.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-21</div><div class="title">Python 函数装饰器 @functools.lru_cache</div></div></a></div><div><a href="/2022/10/54fab998.html" title="Python 的拷贝机制"><img class="cover" src="https://s2.loli.net/2024/03/21/jUW2m6iN94sTDKw.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-21</div><div class="title">Python 的拷贝机制</div></div></a></div><div><a href="/2023/01/3c91fb98.html" title="一个函数实现 Python 超大文件的流式下载与断点续传"><img class="cover" src="https://s2.loli.net/2024/03/21/jUW2m6iN94sTDKw.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-21</div><div class="title">一个函数实现 Python 超大文件的流式下载与断点续传</div></div></a></div><div><a href="/2023/01/2b71833f.html" title="如何将 Python 项目打包为 Docker"><img class="cover" src="https://s2.loli.net/2024/03/21/AtwQFvo9RTePYq4.png" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-05-21</div><div class="title">如何将 Python 项目打包为 Docker</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2024/02/29/ZkKG1RDmgLTqaoE.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">FAWC</div><div class="author-info__description">计算机专业学习者兼游戏狂热爱好者</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/FAWC438"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/FAWC438" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:kevin_lgh@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">本网站的图床 CDN 在国内部分地区访问可能会有点慢，若加载时间过长请尝试刷新页面或更换访问节点🙏</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Apache-SkyWalking-Python-Agent-Performance-Enhancement-Plan"><span class="toc-number">1.</span> <span class="toc-text">Apache SkyWalking - Python Agent Performance Enhancement Plan</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Proposal-for-Google-Summer-of-Code-2023"><span class="toc-number">1.1.</span> <span class="toc-text">Proposal for Google Summer of Code 2023</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#About-Me"><span class="toc-number">1.2.</span> <span class="toc-text">About Me</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Personal-Information"><span class="toc-number">1.2.1.</span> <span class="toc-text">Personal Information</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-Me"><span class="toc-number">1.2.2.</span> <span class="toc-text">Why Me</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Project-Description"><span class="toc-number">1.3.</span> <span class="toc-text">Project Description</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Homework"><span class="toc-number">1.4.</span> <span class="toc-text">Homework</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Familiarity-with-the-Skywalking-Ecosystem"><span class="toc-number">1.4.1.</span> <span class="toc-text">Familiarity with the Skywalking Ecosystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Investigate-Asynchronous-Protocol-API-Implementations"><span class="toc-number">1.4.2.</span> <span class="toc-text">Investigate Asynchronous Protocol API Implementations</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#For-gRPC"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">For gRPC</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#For-Kafka"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">For Kafka</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#For-HTTP"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">For HTTP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Investigate-queues-used-between-both-synchronous-and-asynchronous-code"><span class="toc-number">1.5.</span> <span class="toc-text">Investigate queues used between both synchronous and asynchronous code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Plan"><span class="toc-number">1.6.</span> <span class="toc-text">Plan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Timeline"><span class="toc-number">1.7.</span> <span class="toc-text">Timeline</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/12/6e63371d.html" title="我的 2024 年"><img src="https://s2.loli.net/2024/12/31/8qvOFSmV42hMAG1.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/404.jpg'" alt="我的 2024 年"/></a><div class="content"><a class="title" href="/2024/12/6e63371d.html" title="我的 2024 年">我的 2024 年</a><time datetime="2024-12-31T06:47:18.000Z" title="发表于 2024-12-31 14:47:18">2024-12-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/a9f8b857.html" title="当容量不是 2 的幂次方时，HashMap 是怎么处理的"><img src="https://s2.loli.net/2024/02/26/MjBFKAicaJS1RrX.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/404.jpg'" alt="当容量不是 2 的幂次方时，HashMap 是怎么处理的"/></a><div class="content"><a class="title" href="/2024/07/a9f8b857.html" title="当容量不是 2 的幂次方时，HashMap 是怎么处理的">当容量不是 2 的幂次方时，HashMap 是怎么处理的</a><time datetime="2024-07-21T08:12:15.000Z" title="发表于 2024-07-21 16:12:15">2024-07-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/a2b435f4.html" title="深入解析 HashMap 的哈希算法"><img src="https://s2.loli.net/2024/02/26/MjBFKAicaJS1RrX.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/404.jpg'" alt="深入解析 HashMap 的哈希算法"/></a><div class="content"><a class="title" href="/2024/07/a2b435f4.html" title="深入解析 HashMap 的哈希算法">深入解析 HashMap 的哈希算法</a><time datetime="2024-07-20T15:14:08.000Z" title="发表于 2024-07-20 23:14:08">2024-07-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/12213648.html" title="简述 OAuth 2.0 鉴权架构"><img src="https://s2.loli.net/2024/06/30/eIw8yrLZh1mdPAQ.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/404.jpg'" alt="简述 OAuth 2.0 鉴权架构"/></a><div class="content"><a class="title" href="/2024/06/12213648.html" title="简述 OAuth 2.0 鉴权架构">简述 OAuth 2.0 鉴权架构</a><time datetime="2024-06-30T11:35:06.000Z" title="发表于 2024-06-30 19:35:06">2024-06-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/9d022207.html" title="如何通过 SSH 远程连接另一台 Windows 主机中的 WSL"><img src="https://s2.loli.net/2022/11/11/eW4Utvf5dPFmqsX.png" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/FAWC438/FAWC438.github.io@main/img/404.jpg'" alt="如何通过 SSH 远程连接另一台 Windows 主机中的 WSL"/></a><div class="content"><a class="title" href="/2024/05/9d022207.html" title="如何通过 SSH 远程连接另一台 Windows 主机中的 WSL">如何通过 SSH 远程连接另一台 Windows 主机中的 WSL</a><time datetime="2024-05-06T08:51:09.000Z" title="发表于 2024-05-06 16:51:09">2024-05-06</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2023/09/05/SOnU7VK4tuedDAI.png')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By FAWC</div><div class="footer_custom_text">感谢你看到最后！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.2.0/instantpage.min.js" type="module"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: true,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,d=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=o());for(var e,i=0;i<d.length;i++)0<=(e=(e=d[i]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,a,n,o=d[i];e=function(){d=d.filter(function(t){return o!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(o)},(t=o).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,n=t.getAttribute("data-original"),a.onload=function(){t.src=n,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=n},t.src!==n&&(a.src=n)))}()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)}(this);</script></body></html>